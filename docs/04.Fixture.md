# Покрытие кода и фикстура

## Покрытие кода
[флип](https://disk.yandex.ru/d/150AIWfx3GU3BP/14_CodeCoverage.jpg)
- Понятие трасс выполнения (flow)
- Понятие покрытия
  - Метрика, измеряющая насколько код покрыт тестами
- Разные способы расчета покрытия кода тестами
  - По модулям
  - По классам
  - По методам
  - По строкам кода
  - По трассам выполнения
  - По трассам выполнения + исключения
    - Бесконечное количество вариантов исполнения
    - Полностью покрыть невозможно
- Ловушки покрытия по трассам выполнения на примере FizzBuzz
```Python
def fizzbuzz(n):
    result = ''
    if n % 3 == 0:
       result += 'Fizz'
    if n % 5 == 0:
       result += 'Buzz'
    if not result:
       result = str(n)
    return result

assert fizzbuzz(1) == '1'
assert fizzbuzz(15) == 'FizzBuzz'
```
Формально покрытие кода по трассам выполнения 100%, но на самом деле 2 правила не покрыты тестами.

```Python
def fizzbuzz(n):
    if n % 15 == 0:
       return 'FizzBuzz'
    elif n % 3 == 0:
       return 'Fizz'
    elif n % 5 == 0:
       return 'Buzz'
    else:
      return str(n)

assert fizzbuzz(1) == '1'
assert fizzbuzz(15) == 'FizzBuzz'
```
- Покрытие как метрика не должна использоваться для контроля
- Инструменты расчета покрытия
  - [Flutter](https://codewithandrea.com/articles/flutter-test-coverage/)

## Тюльпан покрытия
![](Images/fixture-coverage-tulip.png)
[Источник: Structure and Interpretation of Test Cases • Kevlin Henney • GOTO 2022](https://youtu.be/MWsk1h8pv2Q?t=1967)
- Простые сценарии
- Распространенные сценарии
- Граничные сценарии
- Ошибочные сценарии

## Подготовка данных
Посмотрите на тесты, которые вы написали. Обратите внимание на то, что логика инициализации во многих тестах дублируется: чтобы протестировать логику ставок, нужно создать игрока, дать ему начальное количество фишек, и только потом можно приступать к логике теста.
Инициализация используются, чтобы
- Избежать дублирования в Arrange
- Подготовить окружение для интеграционных тестов
- Почистить окружение после интеграционных тестов

Инициализацию можно делать
- В тесте
- Во вспомогательных методах
- В SetUp

Опасности использования SetUp:
- Размытие логики теста. Чтобы охватить весь тест, придется смотреть в несколько мест.
- Чрезмерное разрастание логики инициализации. Непонятно что важно для вашего сценария, инициализируется все для всех тестов.

Антипаттерны
- Инициализация объектов, которые нужны части тестов
- Длинная и запутанная инициализация
- Настройка Mock и Fake

## Иерархия тестовых классов
- Абстрактный инфраструктурный класс
  - Содержит общую логику инициализации
  - Не использует SetUp, чтобы не усложнять понимание кода
  - Общая логика вызывается явно из потомков
  - Не используйте больше 1 уровня наследования в тестах
- Шаблонный тестовый класс
  - Базовый класс содержит абстрактные методы для тестов, которые нужно реализовать в наследниках
  - "заполни тесты"
  - Пример: парсинг входных данных в разные выходные форматы (XML, Json, CSV, Plain text)
- Абстрактный тестовый класс
  - "заполни пустые места"
  - Перегрузка фабричного метода

### Упражнение. Осваиваем инициализацию
- Задача: Избавиться от дубликации и лишнего кода в тестах
- Время: 15 минут
- Дебриф: Обращаем внимание на
  - В тестах только значимая информация, которая важна для понимания теста
  - Неважная информация вынесена за пределы теста
  - Тест в идеале состоит из 3 строк

## Выводы
* Какую новую мысль вы узнали в этом модуле?
* Займите положение на шкале от "Мало что понял" до "Все понятно, могу применять"